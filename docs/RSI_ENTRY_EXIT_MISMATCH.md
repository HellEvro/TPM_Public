# Почему многие сделки «не по порогам RSI» и что с этим делать

## Проблема

В отчёте полного анализа сделок только часть входов/выходов соответствуют порогам конфига (LONG RSI≤29, SHORT RSI≥71, выход по RSI 65/60 и 35/40). Ниже — исправления и рекомендации.

## Что исправлено в коде

1. **Критический баг: перезапись `signal` при слиянии таймфреймов** (`filters.py` → `get_coin_rsi_data_for_timeframe`)  
   При расчёте RSI для нескольких ТФ (системный 1m + entry_tf ботов, например 6h) результаты объединялись через `.update(result)`. **Последний** таймфрейм в цикле перезаписывал поле `signal` (и `rsi_zone`, фильтры). В итоге при системном 1m в `coins_rsi_data` оказывался **сигнал от 6h** (например ENTER_SHORT по 6h RSI 85 при 1m RSI 20). Это приводило к входам «не по конфигу» и убыткам.  
   **Исправление:** поля `signal`, `rsi_zone`, `time_filter_info`, `exit_scam_info`, `loss_reentry_info` и `blocked_by_*` заполняются **только для системного таймфрейма** (`timeframe == get_current_timeframe()`). Для остальных ТФ в result попадают только `rsi_key`, `trend_key`, цена — при слиянии сигнал не перезаписывается.

2. **API создание бота / вход** (`api_endpoints.py` → `enter_position_async`):  
   - Направление автовхода больше **не берётся только из `coin_data['signal']`** (он мог быть от другого ТФ до фикса п.1).  
   - RSI читается **строго** через `get_rsi_from_coin_data(coin_data, timeframe=get_current_timeframe())`; убран fallback на `coin_data.get('rsi')`.  
   - Вход разрешён **только если** текущий RSI по системному ТФ в пороге (LONG: RSI ≤ порог, SHORT: RSI ≥ порог). Иначе вход отменён, в лог пишется предупреждение.  
   - При **ручном входе** (`force_manual_entry`) в лог добавлено предупреждение, если направление противоречит текущему RSI (LONG при RSI > порога или SHORT при RSI < порога).

3. **Отчёт `analyze_exchange_trades_full.py`**  
   RSI на **вход** считается по **последней уже закрытой свече** до момента входа (как в боте), а не по свече, содержащей момент входа. Так отчёт не показывает «не в пороге» из-за сдвига по времени свечи.

4. **Перед входом в позицию** (`process_auto_bot_signals` в `filters.py`):  
   - Вход без актуальных RSI-данных запрещён.  
   - RSI читается строго по текущему таймфрейму (`get_rsi_from_coin_data(..., timeframe=current_timeframe)`).  
   - В лог пишется: RSI, порог и таймфрейм при успешной проверке и при пропуске.

5. **Вход «сразу при попадании в диапазон»**  
   Бот принимает решение по **последней закрытой свече** (не по текущей формирующейся). Как только по закрытой свече RSI попадает в порог, сигнал появляется в данных. Проверка сигналов и вход выполняются воркером каждые **check_interval** секунд (по умолчанию 180). Чтобы реагировать быстрее на 1m, в конфиге можно поставить `check_interval: 30` или `60` (сек).

---

## 1. Вход «не по порогу» (LONG при RSI>29, SHORT при RSI<71)

### Возможные причины

| Причина | Пояснение |
|--------|------------|
| **Сигнал от другого ТФ (исправлено)** | Раньше при слиянии RSI по нескольким таймфреймам поле `signal` перезаписывалось последним ТФ (например 6h). При системном 1m это давало вход по 6h RSI вместо 1m — исправлено в `get_coin_rsi_data_for_timeframe` (signal только от системного ТФ). |
| **Ручной вход** | Создание бота с **«Принудительный вход»** / `force_manual_entry` в UI или API. Направление задаётся вручную (LONG/SHORT), **проверка RSI не выполняется**. В лог пишется предупреждение, если направление противоречит текущему RSI. |
| **RSI на закрытии свечи** | В отчёте RSI считается по **закрытию свечи**, в которую попал момент входа. Вход мог быть в начале минуты при RSI 28, к концу минуты RSI уже 50 — в отчёте будет 50. |
| **Другой источник сигнала** | Теоретически возможны другие пути входа (например старый код или внешний скрипт), где пороги не используются. |

### Что делать

- **Ограничить ручной вход без RSI**  
  В `create_bot_endpoint` при `force_manual_entry` можно не давать направление «против» текущего RSI: если пользователь выбрал LONG, а RSI > 29 — показывать предупреждение или не открывать (опционально).
- **Помечать ручные входы**  
  При ручном входе сохранять в состоянии бота флаг `entry_source: 'manual'`. В отчётах и анализе такие сделки считать отдельно от «по RSI».
- **Не менять логику**  
  Оставить ручной вход как есть, но понимать: все сделки с «не по порогу» входа могут быть ручными или из-за разницы «момент входа vs закрытие свечи».

---

## 2. Выход «не по порогу» (закрытие при RSI не 65/35 и т.д.)

### Возможные причины

| Причина | Пояснение |
|--------|------------|
| **Закрытие по TP/SL** | На бирже выставляются **Take Profit** и **Stop Loss**. Позиция часто закрывается **биржей** по TP или SL, а не нашим кодом по RSI. В этот момент RSI может быть любым (45, 55 и т.д.). Код бота закрывает по RSI только когда сам вызывает `_close_position_on_exchange(reason='RSI_EXIT')`. |
| **Ручное закрытие** | Закрытие позиции вручную в UI или на бирже. |
| **Один и тот же тик** | В отчёте видны сделки с входом и выходом в **одну и ту же секунду** (например 14:20:15 → 14:20:15). Это не RSI-выход, а быстрый TP/SL или скальп. |

То есть «выход по эталону: не по порогу» часто означает: **закрытие произошло не по решению RSI, а по TP, SL или вручную**.

### Что делать

- **Принять как факт**  
  TP/SL и ручное закрытие — штатные механизмы. Многие сделки по дизайну закрываются не по RSI.
- **Учитывать причину закрытия в отчётах**  
  - Сделки из **БД** (`bot_trades_history`): там есть `close_reason` (RSI_EXIT, MANUAL_CLOSE и т.д.). В отчёте можно показывать: «закрыто по RSI» / «закрыто по TP/SL/вручную».  
  - Сделки **только с биржи** (`get_closed_pnl`): причины закрытия Bybit в этом API не отдаёт, поэтому все такие сделки в отчёте — без разбивки по причине.
- **Режим «только RSI-выход»**  
  Теоретически можно не выставлять TP/SL и закрывать **только** по RSI. Это повышает риск (нет автоматического ограничения убытка/прибыли), делать только осознанно.

---

## 3. Рекомендуемые шаги

1. **Проверить, как создаются боты**  
   Если часто используется «Принудительный вход» / ручной выбор направления — часть «не по порогу» входов от этого.
2. **В анализе разделять источники**  
   - Сделки из БД с `close_reason = 'RSI_EXIT'` — оценивать по порогам RSI выхода.  
   - Остальные (TP/SL, manual, с биржи без причины) — не считать нарушением эталона RSI.
3. **Опционально: жёстче ручной вход**  
   При ручном входе проверять текущий RSI и либо блокировать вход «против» порогов, либо только предупреждать и помечать `entry_source: 'manual'`.
4. **Скрипт отчёта**  
   В `analyze_exchange_trades_full.py` (и при необходимости в `analyze_trades_rsi_exit.py`) добавить в примечание: «Вход/выход “не по порогу” часто связаны с ручным входом, закрытием по TP/SL или с тем, что RSI берётся по закрытию свечи».

---

## Итог

- **Вход не по порогу** — в основном ручной вход без проверки RSI и/или RSI по закрытию свечи.  
- **Выход не по порогу** — в основном закрытие по TP/SL или вручную, а не по RSI.  
- Строгая проверка «все сделки по порогам RSI» имеет смысл только для сделок, которые реально открыты и закрыты по логике RSI (автовход + закрытие с `close_reason=RSI_EXIT`). Для остальных «не по порогу» — ожидаемое поведение, а не ошибка.
