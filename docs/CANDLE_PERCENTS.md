# Реальные движения свечей и конфиг

Все проценты в конфиге привязаны к **реальным движениям цены**. Никаких виртуальных шкал и пересчётов по таймфрейму — замерил свечи в %, подставил в конфиг.

## bots.py и ai.py — одна логика

- **bots.py**: фильтры (ExitScam, anomaly, LSTM пороги) и AI (should_open_position_with_ai) берут конфиг из `auto_bot_config` (загружается из `bot_engine/bot_config.py`). Формулы и пороги — те же, что ниже.
- **ai.py**: при обучении и симуляциях конфиг берётся из того же источника: при запуске без bots — из `bot_engine/bot_config.py` (DEFAULT_AUTO_BOT_CONFIG) через `bots_data_helper.get_auto_bot_config()`. ExitScam и остальные фильтры в симуляциях считаются по тем же формулам (см. `bot_engine/ai/filter_utils.py`: `run_exit_scam_filter` — тело свечи `|C-O|/O*100`, конфиг как есть).

---

## Как замерить движения свечей

### Одна свеча (тело свечи)

Формула в коде и для замера:

```
% = |close - open| / open * 100
```

- **open**, **close** — цены открытия и закрытия свечи с биржи.
- Пример: open=1.00, close=1.25 → (1.25-1.00)/1.00*100 = **25%**. В конфиг ставишь 25 — блокировка при движении тела свечи > 25%.

Свечи могут расти/падать на **100%, 200%** и больше — конфиг в тех же процентах (100, 200 и т.д.).

### Суммарное движение за N свечей

Формула:

```
% = |last_close - first_open| / first_open * 100
```

- **first_open** — open первой из N свечей.
- **last_close** — close последней из N свечей.
- В конфиг `exit_scam_multi_candle_percent` подставляешь тот же % (например 100 = блокировка при суммарном движении > 100%).

---

## Где что в конфиге

| Параметр | Что значит | Как считается в коде |
|----------|------------|----------------------|
| `exit_scam_single_candle_percent` | Макс. % тела **одной** свечи | `\|C-O\|/O*100` по каждой свече |
| `exit_scam_multi_candle_percent` | Макс. суммарный % за N свечей | `\|last_C - first_O\|/first_O*100` |
| `anomaly_block_threshold` | Порог блокировки по аномалии | Шкала 0–1 (0.7 = 70%). Severity: эвристика = max_change%/100 (100% хода = 1.0) |

Значения в конфиге **как есть**: 15 = 15%, 100 = 100%, без деления на таймфрейм и без скрытых коэффициентов.

---

## Anomaly: severity и эвристика

Когда модель аномалий не обучена, используется эвристика:

- Движение цены между соседними свечами: `(close[i] - close[i-1]) / close[i-1] * 100` — **реальный %**.
- **Severity** по одному правилу (резкое изменение цены): `severity = min(1.0, max_change / 100)` — т.е. **100% хода = 100% severity**, 200% хода = cap 100%.
- Порог блокировки `anomaly_block_threshold`: 0.7 = блокировать при severity > 70%.

Тип аномалии (PUMP/DUMP/MANIPULATION) определяется по последним свечам; проценты там тоже реальные (например «все 5 свечей растут > 3%» — это 3% по формуле close-to-close).
