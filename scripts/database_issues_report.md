# Отчет о проблемах в базах данных и исправлениях

## Найденные проблемы

### 1. ❌ КРИТИЧНО: Таблица `bot_trades_history` отсутствовала в `bots_data.db`
**Проблема**: История торговли ботов не сохранялась, потому что таблица не была создана.

**Исправление**: 
- ✅ Создан скрипт `scripts/fix_bot_trades_history.py` для создания таблицы
- ✅ Таблица создана в существующей базе данных
- ✅ Добавлена в `_init_database()` для автоматического создания в новых базах

### 2. ❌ Ошибка в INSERT запросе: "30 values for 31 columns"
**Проблема**: В методе `save_bot_trade_history()` было 30 плейсхолдеров вместо 31.

**Исправление**: 
- ✅ Исправлен INSERT запрос - добавлен недостающий плейсхолдер

### 3. ❌ История торговли не сохранялась при закрытии позиций
**Проблема**: При закрытии позиций в `bot_class.py` и `sync_and_cache.py` история не сохранялась в `bots_data.db`.

**Исправление**: 
- ✅ Добавлено сохранение в `bots_data.db` в методе `_log_position_closed()` в `bot_class.py`
- ✅ Добавлено сохранение в `bots_data.db` в `sync_and_cache.py` при ручном закрытии
- ✅ Добавлено сохранение в `bots_data.db` в `log_position_opened()` в `bot_history.py`

### 4. ❌ AI система не находила сделки для обучения
**Проблема**: `get_trades_for_training()` загружала сделки только из `ai_data.db`, но история ботов теперь в `bots_data.db`.

**Исправление**: 
- ✅ Обновлен метод `get_trades_for_training()` для загрузки сделок из `bots_data.db -> bot_trades_history`
- ✅ Сделки из `bot_trades_history` теперь включаются в обучение AI

### 5. ❌ Скрипты восстановления истории писали не в ту базу
**Проблема**: 
- `rebuild_bot_history_from_exchange.py` писал в `ai_data.db` вместо `bots_data.db`
- `restore_missing_history.py` работал только с JSON файлами

**Исправление**: 
- ✅ `rebuild_bot_history_from_exchange.py` теперь пишет в `bots_data.db -> bot_trades_history`
- ✅ `restore_missing_history.py` теперь также пишет в `bots_data.db -> bot_trades_history`

### 6. ❌ Миграция существующих данных не выполнялась
**Проблема**: Существующие сделки из `ai_data.db` и `app_data.db` не были мигрированы в `bot_trades_history`.

**Исправление**: 
- ✅ Создан скрипт `scripts/migrate_trades_to_bots_db.py` для миграции
- ✅ Мигрировано 1029 сделок из `app_data.db -> closed_pnl`
- ✅ Миграция из `exchange_trades` требует дополнительной проверки (возможно, все сделки были пропущены как симуляции)

## Текущее состояние баз данных

### bots_data.db
- ✅ `bot_trades_history`: **1030 записей** (1029 закрытых, 1 открытая)
- ✅ `bots`: 18 ботов (все в позиции)
- ✅ Таблица создана и работает

### ai_data.db
- ⚠️ `bot_trades`: 0 записей (история теперь в `bots_data.db`)
- ✅ `exchange_trades`: 554 записи
- ⚠️ `simulated_trades`: 0 записей

### app_data.db
- ✅ `closed_pnl`: 475 записей (мигрировано в `bot_trades_history`)
- ✅ `positions`: 17 открытых позиций

## Что нужно проверить дальше

1. **Почему из `exchange_trades` не мигрировалось?**
   - Возможно, все сделки были пропущены из-за проверки на симуляции
   - Нужно проверить логику фильтрации в `migrate_trades_to_bots_db.py`

2. **Проверить сохранение новых сделок**
   - Убедиться, что при закрытии позиций новые сделки сохраняются в `bot_trades_history`
   - Проверить логи при следующем закрытии позиции

3. **Обновить документацию**
   - Указать, что история торговли ботов теперь в `bots_data.db -> bot_trades_history`
   - Обновить описание источников данных для AI обучения

## Выполненные исправления

1. ✅ Создана таблица `bot_trades_history` в `bots_data.db`
2. ✅ Исправлен INSERT запрос (31 колонка)
3. ✅ Добавлено сохранение истории при открытии/закрытии позиций
4. ✅ Обновлен `get_trades_for_training()` для загрузки из `bots_data.db`
5. ✅ Рефакторинг скриптов восстановления истории
6. ✅ Миграция существующих данных (1029 сделок)

